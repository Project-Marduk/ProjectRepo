/*
 * This Java source file was generated by the Gradle 'init' task.
 */
package Marduk.Javalin.Server;

import ActiveJDBCObjecs.DrawingBoard;
import ActiveJDBCObjecs.DrawingObject;
import FactoryElements.InputObject;
import Marduk.Javalin.Server.DataManager.DataManagerDriver;
import Server.Resources.ServerPorts;
import Server.Resources.ServerReturns;
import Server.Resources.ApiCommands;
import io.javalin.Javalin;
import org.eclipse.jetty.server.Server;
import org.eclipse.jetty.util.thread.QueuedThreadPool;
import org.javalite.activejdbc.Base;
import org.javalite.activejdbc.DB;
import org.javalite.activejdbc.LazyList;
import org.javalite.activejdbc.connection_config.DBConfiguration;

import static ActiveJDBCObjecs.JSONHandler.inputObjectFromJSON;

/**
 * The Info Manager Server
 *
 * @author Traae
 * @version 0.1.0
 */
public class MardukServer {
    private static final int MAX_THREADS = 20;
    private static final int MIN_THREADS = 2;
    private static final int TIMEOUT = 60000;
    private static final int DEFAULT_PORT = ServerPorts.Server.port();



    public static void main(String[] args) {
        ServerReturns currentStatus = ServerReturns.allGood;
        String errorMessage = "No current error.";
        String defaultMessage = ServerReturns.serverMessage.message();
        DataManagerDriver dataManagerDriver = DataManagerDriver.getInstance();

        
        QueuedThreadPool queuedThreadPool = new QueuedThreadPool(MAX_THREADS, MIN_THREADS,TIMEOUT);
        Javalin app = Javalin.create(config ->
                config.server(() ->
                        new Server(queuedThreadPool))).start(ServerPorts.Server.port());

        app.routes(() -> {
            // Basic info calls
            app.get(ApiCommands.root.path(), ctx -> ctx.result(defaultMessage));

            // Check status and Error message
            app.get(ApiCommands.getStatus.path(), ctx -> {
                //STATUS UPDATE FUNCTION
                ctx.result(String.valueOf(currentStatus));
            });
            app.get(ApiCommands.getError.path(), ctx -> {
                // ERROR UPDATING FUNCTION
                ctx.result(errorMessage);
            });




            app.post(ApiCommands.registerUser.path(), ctx -> {
                // [Database User Register and Save Function](ctx.body());
                ctx.result("Register Successful");
            });
            app.get(ApiCommands.loginUser.path(), ctx -> {
                // toLogin = [Database User Load](ctx.body());
                // InfoManager UserLogin( toLogin );
                // ctx.result("Login Succefull");
            });
            app.get(ApiCommands.logoutUser.path(), ctx -> {
                // toLogin = [Database User Load](ctx.body());
                // InfoManager UserLogin( toLogin );
                // ctx.result("Login Succefull");
            });


            app.get(ApiCommands.getDiagram.path(), ctx -> {
                //String diagramName = ctx.body();
                // Diagram toLoad = [Database load Diagram](diagramName);
                // ctx.json(toLoad);
            });
            // Receive a diagram for save.
            app.post(ApiCommands.saveDiagram.path(), ctx -> {
                /*
                NOTE: I still do not full understand this conditional,
                specificly "application/json"

                if (Objects.equals(ctx.contentType(), "application/json")) {
                    // we make a diagram out of the diagram json that was sent to us.
                    // Diagram diagram = ctx.bodyAsClass(Diagram.class);

                    // [Database Save Diagram Function](diagram);

                    ctx.result("Save Successful");
                }*/
            });

            // Receive a diagram for rendering.
            app.post(ApiCommands.renderPNG.path(), ctx -> {
                /*
                NOTE: I still do not full understand this conditional,
                specificly "application/json"

                if (Objects.equals(ctx.contentType(), "application/json")) {
                    // we make a diagram out of the diagram json that was sent to us.
                    Diagram d = ctx.bodyAsClass(Diagram.class);

                    // then we return the result
                    // we can do this one for 3 ways
                    // 1. Return a byte array holding the png's data, and the client can write that to a file
                    // 2. we can use a stream
                    // see: https://javalin.io/archive/docs/v2.8.0.html#context

                    // Using a stream to pass a file seems the most professional.

                    // what ever we choose, we put the FileExporter function into ctx.result( HERE );

                    ctx.result();
                }*/
            });
            app.post(ApiCommands.renderSVG.path(), ctx -> {
                String param = ctx.queryParam("drawing_board_id");

//                new DB("default").open("com.mysql.cj.jdbc.Driver", // DB Connection Class
//                        "projectmarduk.cbvcsctgz8mg.us-west-2.rds.amazonaws.com", // DB URL
//                        "admin", // User Name
//                        "cR4bh4ND5"); // password
                //opens the database from the information in the database.properties in Lib
                DBConfiguration.loadConfiguration("/database.properties");
                Base.open();

                DrawingBoard db = DrawingBoard.findById(Integer.parseInt(param));
                LazyList<DrawingObject> lzDwgObj =  db.getAll(DrawingObject.class); //pulls a lazy list
                String outString = "";

                for (DrawingObject dw :
                        lzDwgObj) {
                    outString += dw.getSVGData();
                }

                Base.close();

                //returns svg data with wrappers
                ctx.result(outString);

//                try{
//                    ctx.result(outString);
//                }
//                catch(IndexOutOfBoundsException e){
//
//                }



                /*
                if (Objects.equals(ctx.contentType(), "application/json")) {
                    Diagram diagram = ctx.bodyAsClass(Diagram.class);

                    // Same as the above function, but we could also pass the whole body of the SVG
                    // as a string and have the client write that to a file.

                    // Once again, using a stream to

                    ctx.result( );

                }
                */
            });
            //needed calls
            //returnSVG : gets all SVG data and returns the string value, will only apply to javaFX
            //createDrawingObject : adds a new drawing object to the drawingboard
            //removeDrawingObject : removes a drawing object from the drawingboard
            //updateDrawingObject : overwrites a drawing object from the drawingboard
            //createDrawingBoard : creates a new drawingboard
            //deleteDrawingBoard : deletes a drawingboard
            app.post(ApiCommands.createDrawingObject.path(), ctx -> {
                //adds a drawing object to the drawing object table
                String param = ctx.queryParam("drawingobjectjson");

                DBConfiguration.loadConfiguration("/database.properties");
                Base.open();

                InputObject inObj = inputObjectFromJSON(param);


                Double p1;
                Double p2 = null;
                String t1;
                String t2 = null;
                String t3 = null;

                if(inObj.getParams().length == 1){
                    p1 = inObj.getParams()[0];
                }
                else{
                    p1 = inObj.getParams()[0];
                    p2 = inObj.getParams()[1];
                }

                if(inObj.getText().length == 1){
                    t1 = inObj.getText()[0];
                }
                else if(inObj.getText().length == 2){
                    t1 = inObj.getText()[0];
                    t2 = inObj.getText()[1];
                }
                else{
                    t1 = inObj.getText()[0];
                    t2 = inObj.getText()[1];
                    t3 = inObj.getText()[2];
                }

                DrawingBoard db = DrawingBoard.findById(inObj.getParent_id());

                DrawingObject.createIt(inObj.getId(), inObj.getParent_id(), inObj.getShapeType(),
                        inObj.getXCord(), inObj.getYCord(), p1, p2, inObj.getColor(), inObj.getStyle(),
                        inObj.getFill(), t1, t2, t3);

                db.saveIt();

                //test
                //object creation that takes in a json and attempts to make it an object
                //check beekeeper to validate
                //

                Base.close();

            });


        });

    }
}
